<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SENIMSU Water AI - Professional Edition</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU0VOSU1TVSBXYXRlciBBSSIsInNob3J0X25hbWUiOiJTRU5JTVNVIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNiM2U1ZmMiLCJ0aGVtZV9jb2xvciI6IiMwMjg4ZDEifQ==">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg-1:#b3e5fc;
    --bg-2:#0288d1;
    --card-bg:#ffffff;
    --accent:#0288d1;
    --muted:#e1f5fe;
    --danger:#ff9800;
    --success:#4caf50;
    --warning:#ff9800;
    --text:#062030;
    --text-light:#324;
    --max-bottle-width:220px;
    --bottle-height:500px;
    --ui-radius:12px;
  }

  [data-theme="dark"]{
    --bg-1:#1a237e;
    --bg-2:#0d47a1;
    --card-bg:#1e1e1e;
    --accent:#42a5f5;
    --muted:#263238;
    --text:#e0e0e0;
    --text-light:#b0bec5;
  }

  @media (prefers-reduced-motion: reduce){
    *{animation-duration:.001ms !important; transition-duration:.001ms !important}
  }

  *{box-sizing:border-box}

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;overflow:hidden;color:var(--text);transition:background 0.3s, color 0.3s}

  .app{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:2vh;
    gap:20px;
  }

  .card{
    width:100%;
    max-width:1100px;
    height:90vh;
    background:var(--card-bg);
    border-radius:20px;
    box-shadow:0 18px 40px rgba(0,0,0,.25);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    position:relative;
    z-index:1;
    transition:background 0.3s;
  }

  .top-nav{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 20px;
    border-bottom:1px solid var(--muted);
    transition:border-color 0.3s;
  }
  .logo{font-size:1.35rem;font-weight:700;color:var(--accent);transition:color 0.3s}
  .nav{display:flex;gap:8px;align-items:center}
  .nav button, .icon-btn{background:transparent;border:0;padding:8px 12px;border-radius:10px;color:var(--accent);cursor:pointer;transition:all 0.2s;font-size:0.95rem}
  .nav button:hover, .icon-btn:hover{background:rgba(2,136,209,0.1);transform:translateY(-1px)}
  .nav button[aria-pressed="true"]{background:var(--accent);color:#fff}
  .icon-btn{padding:8px;font-size:1.2rem}

  .content{display:flex;flex:1;gap:24px;padding:18px;overflow:hidden}
  .left, .right{background:transparent}
  .left{flex:1;min-width:260px;max-width:480px;overflow:auto;padding-right:8px}
  .right{flex:1.3;height:100%;display:flex;flex-direction:column;align-items:stretch}

  .section{display:none}
  .section[aria-hidden="false"]{display:block}

  .source-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:10px;
    margin:12px 0 6px;
  }
  .source-btn{
    padding:12px;
    border-radius:10px;
    border:0;
    background:var(--muted);
    cursor:pointer;
    font-weight:600;
    color:var(--accent);
    transition:all 0.2s;
    position:relative;
    overflow:hidden;
  }
  .source-btn::before{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    width:0;
    height:0;
    border-radius:50%;
    background:rgba(2,136,209,0.2);
    transform:translate(-50%,-50%);
    transition:width 0.3s, height 0.3s;
  }
  .source-btn:active::before{width:300px;height:300px}
  .source-btn:hover{background:rgba(2,136,209,0.2);transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
  .source-btn[aria-pressed="true"]{background:var(--accent);color:#fff;box-shadow:0 4px 12px rgba(2,136,209,0.4)}

  label{display:block;font-weight:600;margin-top:12px;color:var(--text)}
  input[type="number"], select{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:2px solid var(--muted);
    font-size:1rem;
    margin-top:8px;
    background:var(--card-bg);
    color:var(--text);
    transition:border-color 0.2s, box-shadow 0.2s;
  }
  input:focus, select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(2,136,209,0.1);
  }
  
  .primary{
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    border:0;
    background:var(--accent);
    color:white;
    font-weight:700;
    cursor:pointer;
    width:100%;
    transition:all 0.2s;
    position:relative;
    overflow:hidden;
  }
  .primary::before{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    width:0;
    height:0;
    border-radius:50%;
    background:rgba(255,255,255,0.2);
    transform:translate(-50%,-50%);
    transition:width 0.3s, height 0.3s;
  }
  .primary:active::before{width:300px;height:300px}
  .primary:hover{background:#0277bd;transform:translateY(-1px);box-shadow:0 6px 16px rgba(2,136,209,0.3)}
  .primary:active{transform:translateY(0)}

  .output, .advice, .forecast-panel{
    margin-top:12px;
    padding:14px;
    border-radius:10px;
    background:var(--muted);
    display:none;
    transition:background 0.3s;
  }
  .output[aria-hidden="false"], .advice[aria-hidden="false"], .forecast-panel[aria-hidden="false"]{display:block;animation:slideIn 0.3s ease}

  @keyframes slideIn{
    from{opacity:0;transform:translateY(-10px)}
    to{opacity:1;transform:translateY(0)}
  }

  .status{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .status .chip{
    background:var(--muted);
    padding:8px;
    border-radius:8px;
    min-width:110px;
    text-align:center;
    transition:all 0.3s;
    color:var(--text);
  }

  .bottle-wrap{display:flex;align-items:center;justify-content:center;padding:10px 10px 0}
  .bottle-container{
    width:var(--max-bottle-width);
    height:var(--bottle-height);
    position:relative;
    pointer-events:none;
    transform-origin:center;
    animation:float 6s ease-in-out infinite;
  }
  @keyframes float{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-10px)}
  }
  .bottle{
    width:70%;
    height:82%;
    max-width:200px;
    background:rgba(255,255,255,.18);
    border-radius:56px;
    margin:0 auto;
    position:relative;
    box-shadow:inset 0 -6px 14px rgba(0,0,0,.06);
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    align-items:center;
  }

  .bottle .water{
    position:absolute;
    left:0;
    right:0;
    bottom:0;
    height:calc(var(--fill,20) * 1%);
    background:linear-gradient(180deg,#81d4fa,#0288d1);
    border-radius:inherit;
    transition:height .45s cubic-bezier(.2,.8,.2,1), background 0.3s;
    will-change:height;
  }
  .bottle .water.contaminated{background:linear-gradient(180deg,#ffb74d,#f57c00)}
  .bottle .water.safe{background:linear-gradient(180deg,#81c784,#4caf50)}

  .eyes{position:relative;z-index:2;margin-top:72px;display:flex;gap:20px}
  .eye{width:24px;height:28px;background:#2b2b2b;border-radius:50%;transition:transform 0.3s}
  .bottle:hover .eye{transform:scale(1.1)}
  .mouth{width:64px;height:30px;border-bottom:8px solid #333;border-radius:50%;margin-top:8px;transition:transform 0.3s}

  .chart-container{
    position:relative;
    margin-top:10px;
    padding:12px;
    background:var(--card-bg);
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
    transition:background 0.3s;
  }
  canvas{width:100%!important;height:200px!important}

  .profile p{line-height:1.6;color:var(--text-light);transition:color 0.3s}

  #safetyIndicator{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:8px 12px;
    border-radius:8px;
    font-weight:700;
    font-size:0.95rem;
    transition:all 0.3s ease;
    animation:pulse 2s infinite;
  }
  @keyframes pulse{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.05)}
  }
  #safetyIndicator.safe{background:#e6f7ee;color:#1b7a33;border:2px solid #1b7a33;animation:none}
  #safetyIndicator.caution{background:#fff8e1;color:#8a4d00;border:2px solid #8a4d00}
  #safetyIndicator.unsafe{background:#ffebee;color:#c62828;border:2px solid #c62828}

  #analysisSpinner svg{vertical-align:middle;display:inline-block}

  .tooltip-icon{
    display:inline-block;
    width:18px;
    height:18px;
    background:var(--accent);
    color:white;
    border-radius:50%;
    text-align:center;
    line-height:18px;
    font-size:12px;
    cursor:help;
    margin-left:4px;
    transition:transform 0.2s;
  }
  .tooltip-icon:hover{transform:scale(1.2)}

  .treatment-list{margin:12px 0;padding:0;list-style:none}
  .treatment-item{
    padding:10px;
    margin:6px 0;
    background:var(--card-bg);
    border-left:4px solid var(--accent);
    border-radius:4px;
    transition:all 0.2s;
  }
  .treatment-item:hover{transform:translateX(4px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .treatment-item strong{color:var(--accent)}

  .risk-badge{
    display:inline-block;
    padding:4px 8px;
    border-radius:6px;
    font-size:0.85rem;
    font-weight:600;
    margin:2px;
    transition:transform 0.2s;
  }
  .risk-badge:hover{transform:scale(1.05)}
  .risk-low{background:#e6f7ee;color:#1b7a33}
  .risk-medium{background:#fff8e1;color:#8a4d00}
  .risk-high{background:#ffebee;color:#c62828}

  .confidence-meter{
    margin:12px 0;
    height:8px;
    background:#e0e0e0;
    border-radius:4px;
    overflow:hidden;
    position:relative;
  }
  .confidence-fill{
    height:100%;
    background:linear-gradient(90deg,#4caf50,#8bc34a);
    border-radius:4px;
    transition:width 0.5s ease;
  }
  .confidence-fill.medium{background:linear-gradient(90deg,#ff9800,#ffc107)}
  .confidence-fill.low{background:linear-gradient(90deg,#f44336,#ff5722)}

  .anomaly-badge{
    display:inline-block;
    background:#ff5722;
    color:white;
    padding:4px 8px;
    border-radius:4px;
    font-size:0.8rem;
    font-weight:700;
    animation:blink 1.5s infinite;
  }
  @keyframes blink{
    0%,100%{opacity:1}
    50%{opacity:0.7}
  }

  .export-btn{
    margin-top:8px;
    padding:8px 16px;
    border:0;
    background:var(--muted);
    color:var(--accent);
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition:all 0.2s;
  }
  .export-btn:hover{background:var(--accent);color:white;transform:translateY(-1px)}

  .toggle-group{
    display:flex;
    gap:8px;
    margin:12px 0;
    background:var(--muted);
    padding:4px;
    border-radius:10px;
  }
  .toggle-btn{
    flex:1;
    padding:8px;
    border:0;
    background:transparent;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    color:var(--text);
    transition:all 0.2s;
  }
  .toggle-btn.active{background:var(--accent);color:white}

  .forecast-line{
    stroke-dasharray:5,5;
    opacity:0.7;
  }

  @media (max-width:920px){
    .content{flex-direction:column}
    .left{max-width:none}
    .bottle-container{display:none}
  }

  @media (max-width:760px){
    #safetyIndicator{margin-top:8px;display:inline-flex}
    .status{flex-direction:column;gap:6px}
  }

  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}

  .advanced-inputs{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
    margin-top:12px;
  }
  .advanced-inputs input{margin-top:4px}

  .educational-mode{
    background:var(--muted);
    padding:12px;
    border-radius:10px;
    margin-top:12px;
    border-left:4px solid var(--accent);
  }
  .educational-mode h4{margin:0 0 8px 0;color:var(--accent)}
  .educational-mode p{margin:4px 0;font-size:0.9rem;line-height:1.5}
</style>
</head>
<body>

<div class="app" role="application">
  <div class="card" aria-labelledby="appTitle">
    <header class="top-nav">
      <div id="appTitle" class="logo">SENIMSU Pro</div>
      <nav class="nav" aria-label="Main navigation">
        <button type="button" data-target="analyze" aria-pressed="true">Analyze</button>
        <button type="button" data-target="advanced" aria-pressed="false">Advanced</button>
        <button type="button" data-target="forecast" aria-pressed="false">Forecast</button>
        <button type="button" data-target="profile" aria-pressed="false">About</button>
        <button type="button" class="icon-btn" id="themeToggle" title="Toggle dark mode" aria-label="Toggle theme">üåì</button>
      </nav>
    </header>

    <main class="content">
      <section class="left">
        <!-- ANALYZE TAB -->
        <div id="analyze" class="section" aria-hidden="false">
          <h2>AI Water Quality Analyzer</h2>

          <p class="sr-only" id="sourceDesc">Choose water source type</p>
          <div class="source-grid" role="radiogroup" aria-labelledby="sourceDesc">
            <button class="source-btn" type="button" data-source="clean_snow" aria-pressed="false">Clean Snow</button>
            <button class="source-btn" type="button" data-source="urban_snow" aria-pressed="false">Urban Snow</button>
            <button class="source-btn" type="button" data-source="ice" aria-pressed="false">Ice</button>
            <button class="source-btn" type="button" data-source="sleet" aria-pressed="false">Sleet</button>
            <button class="source-btn" type="button" data-source="river" aria-pressed="false">River</button>
            <button class="source-btn" type="button" data-source="lake" aria-pressed="false">Lake</button>
            <button class="source-btn" type="button" data-source="tap" aria-pressed="false">Tap</button>
            <button class="source-btn" type="button" data-source="rain" aria-pressed="false">Rain</button>
            <button class="source-btn" type="button" data-source="glacier_melt" aria-pressed="false">Glacier Melt</button>
            <button class="source-btn" type="button" data-source="well" aria-pressed="false">Well</button>
            <button class="source-btn" type="button" data-source="spring" aria-pressed="false">Spring</button>
            <button class="source-btn" type="button" data-source="pond" aria-pressed="false">Pond</button>
          </div>

          <p>Selected: <strong id="selected">None</strong></p>

          <label for="before">Enter turbidity (NTU) <span class="tooltip-icon" title="Nephelometric Turbidity Units - measure of water cloudiness. Safe drinking water: <1 NTU, Typical river: 10-100 NTU">‚ÑπÔ∏è</span></label>
          <input id="before" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 85.4" aria-describedby="beforeHelp">
          <div id="beforeHelp" class="sr-only">Turbidity in Nephelometric Turbidity Units (NTU)</div>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px">
            <button class="primary" id="analyzeBtn" type="button" style="flex:1;min-width:120px">Analyze</button>
            
            <span id="analysisSpinner" aria-hidden="true" style="display:none" title="Analyzing">
              <svg width="18" height="18" viewBox="0 0 50 50" aria-hidden="true">
                <circle cx="25" cy="25" r="20" fill="none" stroke="rgba(2,136,209,0.9)" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4">
                  <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.9s" repeatCount="indefinite" />
                </circle>
              </svg>
            </span>

            <div id="safetyIndicator" role="status" aria-live="polite">
              <span id="safetyIcon"></span>
              <span id="safetyText">‚Äî</span>
            </div>
          </div>

          <div id="confidenceMeterContainer" style="display:none;margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-size:0.85rem;font-weight:600">Analysis Confidence</span>
              <span id="confidenceText" style="font-size:0.85rem;font-weight:600">‚Äî</span>
            </div>
            <div class="confidence-meter">
              <div id="confidenceFill" class="confidence-fill" style="width:0%"></div>
            </div>
          </div>

          <aside id="output" class="output" role="status" aria-live="polite" aria-hidden="true"></aside>
          <div id="advice" class="advice" aria-hidden="true"></div>

          <div class="status" aria-hidden="false">
            <div id="liveDepth" class="chip">Depth: --%</div>
            <div id="liveClean" class="chip">Cleanliness: --%</div>
            <div id="anomalyChip" class="chip" style="display:none"></div>
          </div>

          <div style="margin-top:12px">
            <button class="export-btn" id="exportCSV">üìä Export CSV</button>
            <button class="export-btn" id="exportPNG">üì∏ Export Chart</button>
            <button class="export-btn" id="clearHistory">üóëÔ∏è Clear History</button>
          </div>
        </div>

        <!-- ADVANCED TAB -->
        <div id="advanced" class="section" aria-hidden="true">
          <h2>Advanced Parameters</h2>
          <p style="font-size:0.9rem;color:var(--text-light)">Optional: Add environmental data for improved accuracy</p>

          <div class="advanced-inputs">
            <div>
              <label for="temperature">Temperature (¬∞C)</label>
              <input id="temperature" type="number" step="0.1" placeholder="Optional">
            </div>
            <div>
              <label for="ph">pH Level</label>
              <input id="ph" type="number" step="0.1" min="0" max="14" placeholder="0-14">
            </div>
            <div>
              <label for="flowRate">Flow Rate (L/min)</label>
              <input id="flowRate" type="number" step="0.1" min="0" placeholder="Optional">
            </div>
            <div>
              <label for="seasonOverride">Season Override</label>
              <select id="seasonOverride">
                <option value="auto">Auto-detect</option>
                <option value="winter">Winter</option>
                <option value="spring">Spring</option>
                <option value="summer">Summer</option>
                <option value="autumn">Autumn</option>
              </select>
            </div>
          </div>

          <label style="margin-top:16px">
            <input type="checkbox" id="educationalMode"> Educational Mode
          </label>
          <p style="font-size:0.85rem;margin-top:4px;color:var(--text-light)">Show detailed explanations and learning content</p>

          <label style="margin-top:12px">
            <input type="checkbox" id="plainLanguage"> Plain Language Mode
          </label>
          <p style="font-size:0.85rem;margin-top:4px;color:var(--text-light)">Simplified technical terms for non-experts</p>
        </div>

        <!-- FORECAST TAB -->
        <div id="forecast" class="section" aria-hidden="true">
          <h2>Predictive Forecast</h2>
          <p style="font-size:0.9rem;color:var(--text-light)">Based on historical data patterns</p>

          <div class="toggle-group">
            <button class="toggle-btn active" data-forecast="7">7 Days</button>
            <button class="toggle-btn" data-forecast="30">30 Days</button>
          </div>

          <button class="primary" id="generateForecast">Generate Forecast</button>

          <div id="forecastOutput" class="forecast-panel" aria-hidden="true">
            <h3 style="margin-top:0">Forecast Results</h3>
            <div id="forecastContent"></div>
          </div>
        </div>

        <!-- ABOUT TAB -->
        <div id="profile" class="section" aria-hidden="true">
          <h2>About SENIMSU Pro</h2>
          <div class="profile">
            <p>
              <strong>SENIMSU Water AI Professional Edition</strong> simulates biochar filtration using an advanced knowledge-based model with predictive analytics.
            </p>
            <p>
              <strong>Core Features:</strong>
            </p>
            <ul>
              <li>Multi-factor contamination risk assessment</li>
              <li>Seasonal & temperature variation analysis</li>
              <li>Trend detection with anomaly alerts</li>
              <li>7/30-day turbidity forecasting</li>
              <li>Confidence scoring with transparency</li>
              <li>Treatment recommendations (9 methods)</li>
              <li>Data export (CSV, PNG)</li>
              <li>Dark mode & PWA support</li>
            </ul>
            <p>
              <strong>Data Persistence:</strong> All analysis history is stored locally in your browser. Data persists across sessions.
            </p>
            <p>
              <strong>Safety Note:</strong> This tool provides estimates only. Always verify water quality with professional laboratory testing before consumption.
            </p>
            <p style="font-size:0.85rem;color:var(--text-light);margin-top:16px">
              Version 2.0 Professional | Fully offline capable | No data transmitted
            </p>
          </div>
        </div>
      </section>

      <aside class="right" aria-hidden="false">
        <div class="bottle-wrap" aria-hidden="true">
          <div class="bottle-container" id="bottleContainer" aria-hidden="true">
            <div class="bottle" role="img" aria-label="Water bottle visualization" style="--fill:20">
              <div class="water" id="bottleWater" aria-hidden="true"></div>
              <div class="eyes" aria-hidden="true"><span class="eye"></span><span class="eye"></span></div>
              <div class="mouth" aria-hidden="true"></div>
            </div>
          </div>
        </div>

        <div style="padding:12px;flex:1;display:flex;flex-direction:column">
          <div class="chart-container">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Turbidity Trend</strong>
              <div class="toggle-group" style="margin:0;padding:2px;font-size:0.8rem">
                <button class="toggle-btn active" data-chart="line" style="padding:4px 8px">Line</button>
                <button class="toggle-btn" data-chart="area" style="padding:4px 8px">Area</button>
              </div>
            </div>
            <canvas id="mainChart" aria-label="Water quality over time"></canvas>
          </div>

          <div style="margin-top:auto;font-size:.9rem;color:var(--text-light);padding-top:12px">
            <p style="margin:0"><em>Tip:</em> Run multiple analyses to see trends and enable forecasting. Anomalies will be automatically detected.</p>
          </div>
        </div>
      </aside>
    </main>
  </div>
</div>

<div id="srAnnouncement" class="sr-only" aria-live="polite"></div>

<script>
(function () {
  'use strict';

  const SAFE_TURBIDITY = 100;
  const MAX_SERIES = 50;
  const MIN_CONFIDENCE = 10;
  const STORAGE_KEY = 'senimsu_data_v2';
  const THEME_KEY = 'senimsu_theme';
  
  const SAFETY = { SAFE: 'Safe', CAUTION: 'Caution', UNSAFE: 'Unsafe' };
  const SAFETY_ICONS = { 'Safe': '‚úì', 'Caution': '‚ö†', 'Unsafe': '‚úó' };

  // State
  let state = {
    source: null,
    history: [],
    chart: null,
    chartType: 'line',
    forecastDays: 7,
    advancedParams: {},
    educationalMode: false,
    plainLanguage: false
  };

  // Water source risk profiles
  const sourceProfiles = {
    clean_snow: { baseRisk: 0.15, seasonal: true, contamFactor: 0.8 },
    urban_snow: { baseRisk: 0.45, seasonal: true, contamFactor: 1.4 },
    ice: { baseRisk: 0.2, seasonal: true, contamFactor: 0.9 },
    sleet: { baseRisk: 0.35, seasonal: true, contamFactor: 1.2 },
    river: { baseRisk: 0.5, seasonal: false, contamFactor: 1.5 },
    lake: { baseRisk: 0.4, seasonal: false, contamFactor: 1.3 },
    tap: { baseRisk: 0.1, seasonal: false, contamFactor: 0.7 },
    rain: { baseRisk: 0.3, seasonal: false, contamFactor: 1.1 },
    glacier_melt: { baseRisk: 0.15, seasonal: true, contamFactor: 0.85 },
    well: { baseRisk: 0.25, seasonal: false, contamFactor: 1.0 },
    spring: { baseRisk: 0.2, seasonal: false, contamFactor: 0.95 },
    pond: { baseRisk: 0.55, seasonal: false, contamFactor: 1.6 }
  };

  // Treatment methods
  const treatments = {
    boiling: { effectiveness: 0.95, time: '5-10 min', cost: 'Low' },
    chlorination: { effectiveness: 0.90, time: '30 min', cost: 'Low' },
    uv: { effectiveness: 0.99, time: '1-2 min', cost: 'Medium' },
    reverse_osmosis: { effectiveness: 0.98, time: 'Continuous', cost: 'High' },
    ceramic_filter: { effectiveness: 0.85, time: 'Continuous', cost: 'Medium' },
    activated_carbon: { effectiveness: 0.80, time: 'Continuous', cost: 'Medium' },
    distillation: { effectiveness: 0.99, time: '2-3 hours', cost: 'High' },
    biochar: { effectiveness: 0.75, time: 'Varies', cost: 'Low' },
    settling: { effectiveness: 0.50, time: '2-12 hours', cost: 'Free' }
  };

  // Initialize
  function init() {
    loadData();
    loadTheme();
    setupEventListeners();
    initChart();
    updateUI();
  }

  // Event Listeners
  function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav button[data-target]').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.target));
    });

    // Source selection
    document.querySelectorAll('.source-btn').forEach(btn => {
      btn.addEventListener('click', () => selectSource(btn.dataset.source));
    });

    // Analysis
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('before').addEventListener('keypress', e => {
      if (e.key === 'Enter') analyze();
    });

    // Chart type toggle
    document.querySelectorAll('[data-chart]').forEach(btn => {
      btn.addEventListener('click', () => toggleChartType(btn.dataset.chart));
    });

    // Forecast
    document.querySelectorAll('[data-forecast]').forEach(btn => {
      btn.addEventListener('click', () => setForecastDays(parseInt(btn.dataset.forecast)));
    });
    document.getElementById('generateForecast').addEventListener('click', generateForecast);

    // Export
    document.getElementById('exportCSV').addEventListener('click', exportCSV);
    document.getElementById('exportPNG').addEventListener('click', exportPNG);
    document.getElementById('clearHistory').addEventListener('click', clearHistory);

    // Theme
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Advanced settings
    document.getElementById('educationalMode').addEventListener('change', e => {
      state.educationalMode = e.target.checked;
    });
    document.getElementById('plainLanguage').addEventListener('change', e => {
      state.plainLanguage = e.target.checked;
    });

    // Advanced parameters
    ['temperature', 'ph', 'flowRate', 'seasonOverride'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', () => {
        state.advancedParams[id] = el.value;
      });
    });
  }

  // Tab switching
  function switchTab(target) {
    document.querySelectorAll('.section').forEach(s => s.setAttribute('aria-hidden', 'true'));
    document.getElementById(target).setAttribute('aria-hidden', 'false');
    
    document.querySelectorAll('.nav button[data-target]').forEach(btn => {
      btn.setAttribute('aria-pressed', btn.dataset.target === target);
    });
  }

  // Source selection
  function selectSource(source) {
    state.source = source;
    document.querySelectorAll('.source-btn').forEach(btn => {
      btn.setAttribute('aria-pressed', btn.dataset.source === source);
    });
    document.getElementById('selected').textContent = source.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
  }

  // Main analysis function
  function analyze() {
    const turbidity = parseFloat(document.getElementById('before').value);
    
    if (!state.source) {
      alert('Please select a water source first');
      return;
    }
    
    if (isNaN(turbidity) || turbidity < 0) {
      alert('Please enter a valid turbidity value (‚â•0)');
      return;
    }

    showSpinner(true);
    
    setTimeout(() => {
      const result = performAnalysis(turbidity);
      displayResults(result);
      updateChart();
      checkAnomalies();
      showSpinner(false);
      saveData();
    }, 800);
  }

  // Core analysis logic with enhanced features
  function performAnalysis(turbidity) {
    const profile = sourceProfiles[state.source];
    const timestamp = Date.now();
    
    // Calculate confidence based on data history
    const confidence = calculateConfidence();
    
    // Risk calculation with advanced parameters
    let riskScore = profile.baseRisk * profile.contamFactor * (turbidity / 100);
    
    // Apply advanced parameters
    if (state.advancedParams.temperature) {
      const temp = parseFloat(state.advancedParams.temperature);
      if (temp > 25) riskScore *= 1.15;
      if (temp < 5) riskScore *= 0.9;
    }
    
    if (state.advancedParams.ph) {
      const ph = parseFloat(state.advancedParams.ph);
      if (ph < 6.5 || ph > 8.5) riskScore *= 1.2;
    }
    
    if (state.advancedParams.flowRate) {
      const flow = parseFloat(state.advancedParams.flowRate);
      if (flow > 10) riskScore *= 1.1;
    }
    
    // Seasonal adjustment
    const season = getCurrentSeason();
    if (profile.seasonal && (season === 'spring' || season === 'summer')) {
      riskScore *= 1.15;
    }
    
    // Calculate reduction (biochar simulation)
    const reduction = Math.min(95, 40 + (turbidity * 0.3) + (Math.random() * 10));
    const afterTurbidity = turbidity * (1 - reduction / 100);
    
    // Safety assessment
    let safety = SAFETY.SAFE;
    if (afterTurbidity > 5) safety = SAFETY.CAUTION;
    if (afterTurbidity > 15 || turbidity > 200) safety = SAFETY.UNSAFE;
    
    // Get treatment recommendations
    const recommendedTreatments = getRecommendedTreatments(turbidity, safety);
    
    const result = {
      timestamp,
      source: state.source,
      before: turbidity,
      after: afterTurbidity,
      reduction,
      safety,
      confidence,
      riskScore: Math.min(1, riskScore),
      treatments: recommendedTreatments,
      advancedParams: { ...state.advancedParams }
    };
    
    state.history.push(result);
    if (state.history.length > MAX_SERIES) state.history.shift();
    
    return result;
  }

  // Calculate analysis confidence
  function calculateConfidence() {
    const historyCount = state.history.length;
    let confidence = MIN_CONFIDENCE + (historyCount * 5);
    
    // Cap at 95% for realism
    confidence = Math.min(95, confidence);
    
    // Reduce confidence if high variance in recent data
    if (historyCount >= 5) {
      const recent = state.history.slice(-5).map(r => r.before);
      const variance = calculateVariance(recent);
      if (variance > 500) confidence *= 0.85;
    }
    
    return Math.round(confidence);
  }

  // Calculate variance
  function calculateVariance(arr) {
    const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
    const squareDiffs = arr.map(val => Math.pow(val - mean, 2));
    return squareDiffs.reduce((a, b) => a + b, 0) / arr.length;
  }

  // Get current season
  function getCurrentSeason() {
    if (state.advancedParams.seasonOverride && state.advancedParams.seasonOverride !== 'auto') {
      return state.advancedParams.seasonOverride;
    }
    
    const month = new Date().getMonth();
    if (month >= 2 && month <= 4) return 'spring';
    if (month >= 5 && month <= 7) return 'summer';
    if (month >= 8 && month <= 10) return 'autumn';
    return 'winter';
  }

  // Get treatment recommendations
  function getRecommendedTreatments(turbidity, safety) {
    const recommended = [];
    
    if (safety === SAFETY.UNSAFE) {
      recommended.push('reverse_osmosis', 'distillation', 'uv');
    } else if (safety === SAFETY.CAUTION) {
      recommended.push('uv', 'ceramic_filter', 'boiling');
    } else {
      recommended.push('boiling', 'activated_carbon', 'chlorination');
    }
    
    if (turbidity > 50) {
      if (!recommended.includes('settling')) recommended.unshift('settling');
    }
    
    return recommended.slice(0, 3);
  }

  // Display results
  function displayResults(result) {
    const output = document.getElementById('output');
    const advice = document.getElementById('advice');
    
    // Update safety indicator
    const indicator = document.getElementById('safetyIndicator');
    indicator.className = result.safety.toLowerCase();
    document.getElementById('safetyIcon').textContent = SAFETY_ICONS[result.safety];
    document.getElementById('safetyText').textContent = result.safety;
    
    // Update confidence meter
    const confContainer = document.getElementById('confidenceMeterContainer');
    confContainer.style.display = 'block';
    document.getElementById('confidenceText').textContent = `${result.confidence}%`;
    
    const confFill = document.getElementById('confidenceFill');
    confFill.style.width = `${result.confidence}%`;
    confFill.className = 'confidence-fill';
    if (result.confidence < 50) confFill.classList.add('low');
    else if (result.confidence < 75) confFill.classList.add('medium');
    
    // Main output
    let outputHTML = `<strong>Analysis Results:</strong><br>`;
    outputHTML += `Before: ${result.before.toFixed(1)} NTU<br>`;
    outputHTML += `After: ${result.after.toFixed(1)} NTU<br>`;
    outputHTML += `Reduction: ${result.reduction.toFixed(1)}%<br>`;
    outputHTML += `Risk Score: <span class="risk-badge risk-${getRiskLevel(result.riskScore)}">${(result.riskScore * 100).toFixed(0)}%</span>`;
    
    output.innerHTML = outputHTML;
    output.setAttribute('aria-hidden', 'false');
    
    // Treatment advice
    let adviceHTML = `<strong>Recommended Treatments:</strong>`;
    adviceHTML += `<ul class="treatment-list">`;
    
    result.treatments.forEach(t => {
      const method = treatments[t];
      const name = state.plainLanguage ? getPlainName(t) : t.replace(/_/g, ' ');
      adviceHTML += `<li class="treatment-item">`;
      adviceHTML += `<strong>${name}</strong><br>`;
      adviceHTML += `Effectiveness: ${(method.effectiveness * 100).toFixed(0)}% | `;
      adviceHTML += `Time: ${method.time} | Cost: ${method.cost}`;
      adviceHTML += `</li>`;
    });
    
    adviceHTML += `</ul>`;
    
    // Educational mode
    if (state.educationalMode) {
      adviceHTML += `<div class="educational-mode">`;
      adviceHTML += `<h4>üìö Why This Matters</h4>`;
      adviceHTML += `<p>Turbidity measures suspended particles in water. High turbidity can harbor harmful bacteria and reduce treatment effectiveness.</p>`;
      adviceHTML += `<p>Your water source (${state.source.replace(/_/g, ' ')}) has a base contamination risk of ${(sourceProfiles[state.source].baseRisk * 100).toFixed(0)}%.</p>`;
      adviceHTML += `</div>`;
    }
    
    advice.innerHTML = adviceHTML;
    advice.setAttribute('aria-hidden', 'false');
    
    // Update status chips
    document.getElementById('liveDepth').textContent = `Depth: ${result.reduction.toFixed(0)}%`;
    document.getElementById('liveClean').textContent = `Cleanliness: ${(100 - result.riskScore * 100).toFixed(0)}%`;
    
    // Update bottle visualization
    updateBottle(result);
    
    // Announce to screen readers
    announce(`Analysis complete. Safety level: ${result.safety}. Turbidity reduced from ${result.before.toFixed(1)} to ${result.after.toFixed(1)} NTU.`);
  }

  // Get plain language names
  function getPlainName(treatment) {
    const names = {
      boiling: 'Boil Water',
      chlorination: 'Add Chlorine',
      uv: 'UV Light Treatment',
      reverse_osmosis: 'Advanced Filter (RO)',
      ceramic_filter: 'Ceramic Filter',
      activated_carbon: 'Carbon Filter',
      distillation: 'Boil & Collect Steam',
      biochar: 'Charcoal Filter',
      settling: 'Let Particles Settle'
    };
    return names[treatment] || treatment;
  }

  // Get risk level label
  function getRiskLevel(score) {
    if (score < 0.3) return 'low';
    if (score < 0.6) return 'medium';
    return 'high';
  }

  // Update bottle visualization
  function updateBottle(result) {
    const water = document.getElementById('bottleWater');
    const fillPercent = Math.min(100, Math.max(10, 100 - result.after * 2));
    
    document.querySelector('.bottle').style.setProperty('--fill', fillPercent);
    
    water.className = 'water';
    if (result.safety === SAFETY.SAFE) water.classList.add('safe');
    else if (result.safety === SAFETY.UNSAFE) water.classList.add('contaminated');
  }

  // Chart initialization
  function initChart() {
    const ctx = document.getElementById('mainChart');
    state.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Before Treatment',
          data: [],
          borderColor: '#ff9800',
          backgroundColor: 'rgba(255,152,0,0.1)',
          tension: 0.4,
          fill: false
        }, {
          label: 'After Treatment',
          data: [],
          borderColor: '#4caf50',
          backgroundColor: 'rgba(76,175,80,0.1)',
          tension: 0.4,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            callbacks: {
              afterLabel: function(context) {
                const idx = context.dataIndex;
                if (state.history[idx]) {
                  return `Safety: ${state.history[idx].safety}`;
                }
                return '';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Turbidity (NTU)' }
          },
          x: {
            title: { display: true, text: 'Analysis #' }
          }
        }
      }
    });
  }

  // Update chart
  function updateChart() {
    const labels = state.history.map((_, i) => `#${i + 1}`);
    const before = state.history.map(r => r.before);
    const after = state.history.map(r => r.after);
    
    state.chart.data.labels = labels;
    state.chart.data.datasets[0].data = before;
    state.chart.data.datasets[1].data = after;
    
    // Apply chart type
    if (state.chartType === 'area') {
      state.chart.data.datasets[0].fill = true;
      state.chart.data.datasets[1].fill = true;
    } else {
      state.chart.data.datasets[0].fill = false;
      state.chart.data.datasets[1].fill = false;
    }
    
    state.chart.update('none');
  }

  // Toggle chart type
  function toggleChartType(type) {
    state.chartType = type;
    document.querySelectorAll('[data-chart]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.chart === type);
    });
    updateChart();
  }

  // Anomaly detection
  function checkAnomalies() {
    if (state.history.length < 3) return;
    
    const recent = state.history.slice(-3);
    const current = recent[2].before;
    const prev1 = recent[1].before;
    const prev2 = recent[0].before;
    
    const avgPrev = (prev1 + prev2) / 2;
    const change = Math.abs(current - avgPrev) / avgPrev;
    
    const anomalyChip = document.getElementById('anomalyChip');
    
    if (change > 0.5) {
      anomalyChip.innerHTML = `<span class="anomaly-badge">‚ö° Anomaly Detected</span>`;
      anomalyChip.style.display = 'block';
      
      if (current > avgPrev) {
        announce('Warning: Sudden turbidity increase detected. Possible contamination event.');
      } else {
        announce('Note: Sudden turbidity decrease detected. Verify measurement.');
      }
    } else {
      anomalyChip.style.display = 'none';
    }
  }

  // Forecast generation
  function generateForecast() {
    if (state.history.length < 3) {
      alert('Need at least 3 historical analyses to generate forecast');
      return;
    }
    
    const forecast = calculateForecast(state.forecastDays);
    displayForecast(forecast);
  }

  // Forecast calculation (moving average + linear trend)
  function calculateForecast(days) {
    const recent = state.history.slice(-7).map(r => r.before);
    const n = recent.length;
    
    // Calculate trend
    let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    for (let i = 0; i < n; i++) {
      sumX += i;
      sumY += recent[i];
      sumXY += i * recent[i];
      sumX2 += i * i;
    }
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    // Generate predictions
    const predictions = [];
    for (let i = 1; i <= days; i++) {
      const predicted = intercept + slope * (n + i);
      predictions.push(Math.max(0, predicted));
    }
    
    return { predictions, trend: slope > 0 ? 'increasing' : 'decreasing' };
  }

  // Display forecast
  function displayForecast(forecast) {
    const output = document.getElementById('forecastOutput');
    const content = document.getElementById('forecastContent');
    
    let html = `<p><strong>Trend:</strong> Turbidity is ${forecast.trend} over time.</p>`;
    html += `<p><strong>${state.forecastDays}-Day Predictions:</strong></p>`;
    html += `<ul style="list-style:none;padding:0">`;
    
    forecast.predictions.forEach((pred, i) => {
      html += `<li style="padding:4px 0">Day ${i + 1}: ${pred.toFixed(1)} NTU</li>`;
    });
    
    html += `</ul>`;
    html += `<p style="font-size:0.85rem;color:var(--text-light);margin-top:12px">`;
    html += `<em>Note: Forecast based on historical trends. Actual values may vary due to environmental factors.</em>`;
    html += `</p>`;
    
    content.innerHTML = html;
    output.setAttribute('aria-hidden', 'false');
  }

  // Set forecast days
  function setForecastDays(days) {
    state.forecastDays = days;
    document.querySelectorAll('[data-forecast]').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.forecast) === days);
    });
  }

  // Export CSV
  function exportCSV() {
    if (state.history.length === 0) {
      alert('No data to export');
      return;
    }
    
    let csv = 'Timestamp,Source,Before (NTU),After (NTU),Reduction (%),Safety,Confidence (%),Risk Score\n';
    
    state.history.forEach(r => {
      const date = new Date(r.timestamp).toISOString();
      csv += `${date},${r.source},${r.before},${r.after},${r.reduction},${r.safety},${r.confidence},${r.riskScore}\n`;
    });
    
    downloadFile(csv, 'senimsu_analysis.csv', 'text/csv');
  }

  // Export PNG
  function exportPNG() {
    if (!state.chart) return;
    
    const url = state.chart.toBase64Image();
    const link = document.createElement('a');
    link.download = 'senimsu_chart.png';
    link.href = url;
    link.click();
  }

  // Download file helper
  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = filename;
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
  }

  // Clear history
  function clearHistory() {
    if (!confirm('Clear all analysis history? This cannot be undone.')) return;
    
    state.history = [];
    saveData();
    updateChart();
    updateUI();
    
    document.getElementById('output').setAttribute('aria-hidden', 'true');
    document.getElementById('advice').setAttribute('aria-hidden', 'true');
    document.getElementById('confidenceMeterContainer').style.display = 'none';
    document.getElementById('anomalyChip').style.display = 'none';
    
    announce('History cleared');
  }

  // Theme toggle
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    const next = current === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem(THEME_KEY, next);
  }

  // Load theme
  function loadTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved) {
      document.documentElement.setAttribute('data-theme', saved);
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  }

  // Save data
  function saveData() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        history: state.history,
        source: state.source,
        chartType: state.chartType,
        forecastDays: state.forecastDays
      }));
    } catch (e) {
      console.error('Failed to save data:', e);
    }
  }

  // Load data
  function loadData() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const data = JSON.parse(saved);
        state.history = data.history || [];
        state.source = data.source;
        state.chartType = data.chartType || 'line';
        state.forecastDays = data.forecastDays || 7;
      }
    } catch (e) {
      console.error('Failed to load data:', e);
    }
  }

  // Update UI from state
  function updateUI() {
    if (state.source) {
      selectSource(state.source);
    }
    if (state.history.length > 0) {
      updateChart();
    }
  }

  // Show/hide spinner
  function showSpinner(show) {
    document.getElementById('analysisSpinner').style.display = show ? 'inline-block' : 'none';
  }

  // Announce to screen readers
  function announce(msg) {
    const sr = document.getElementById('srAnnouncement');
    sr.textContent = msg;
    setTimeout(() => sr.textContent = '', 1000);
  }

  // Start app
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
