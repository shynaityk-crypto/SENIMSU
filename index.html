<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SENIMSU Water AI</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

<style>
  :root{
    --bg-1:#b3e5fc;
    --bg-2:#0288d1;
    --card-bg:#ffffff;
    --accent:#0288d1;
    --muted:#e1f5fe;
    --danger:#ff9800;
    --max-bottle-width:220px;
    --bottle-height:500px;
    --ui-radius:12px;
  }

  /* Reduced motion respect */
  @media (prefers-reduced-motion: reduce){
    *{animation-duration:.001ms !important; transition-duration:.001ms !important}
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Arial, sans-serif;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));-webkit-font-smoothing:antialiased;overflow:hidden}

  /* Layout */
  .app{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:2vh;
    box-sizing:border-box;
    gap:20px;
  }

  /* Card */
  .card{
    width:100%;
    max-width:1000px;
    height:90vh;
    background:var(--card-bg);
    border-radius:20px;
    box-shadow:0 18px 40px rgba(0,0,0,.25);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    position:relative;
    z-index:1;
  }

  .top-nav{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--muted)}
  .logo{font-size:1.35rem;font-weight:700;color:#0277bd}
  .nav{display:flex;gap:8px;align-items:center}
  .nav button{background:transparent;border:0;padding:8px 12px;border-radius:10px;color:#01579b;cursor:pointer}
  .nav button[aria-pressed="true"]{background:var(--accent);color:#fff}

  .content{display:flex;flex:1;gap:24px;padding:18px;box-sizing:border-box;overflow:hidden}
  .left, .right{background:transparent}
  .left{flex:1;min-width:260px;max-width:460px;overflow:auto;padding-right:8px}
  .right{flex:1.3;height:100%;display:flex;flex-direction:column;align-items:stretch}

  .section{display:none}
  .section[aria-hidden="false"]{display:block}

  .source-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:10px;
    margin:12px 0 6px;
  }
  .source-btn{
    padding:12px;border-radius:10px;border:0;background:var(--muted);cursor:pointer;font-weight:600;color:#01579b;
  }
  .source-btn[aria-pressed="true"]{background:var(--accent);color:#fff}

  label{display:block;font-weight:600;margin-top:12px}
  input[type="number"]{
    width:100%;
    padding:12px;border-radius:10px;border:2px solid #ddd;font-size:1rem;margin-top:8px;box-sizing:border-box;
  }
  .primary{
    margin-top:12px;padding:12px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:700;cursor:pointer;width:100%;
  }

  .output, .advice{margin-top:12px;padding:14px;border-radius:10px;background:var(--muted);display:none}
  .output[aria-hidden="false"], .advice[aria-hidden="false"]{display:block}

  .status{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .status .chip{background:#eaf7ff;padding:8px;border-radius:8px;min-width:110px;text-align:center}

  /* Bottle (visual) placed on the right column header */
  .bottle-wrap{display:flex;align-items:center;justify-content:center;padding:10px 10px 0}
  .bottle-container{
    width:var(--max-bottle-width);
    height:var(--bottle-height);
    position:relative;
    pointer-events:none;
    transform-origin:center;
    --float:0;
    animation:float 6s ease-in-out infinite;
  }
  @keyframes float{
    0%,100%{transform:translateY(0)}
    50%{transform:translateY(-10px)}
  }
  .bottle{
    width:70%;
    height:82%;
    max-width:200px;
    background:rgba(255,255,255,.18);
    border-radius:56px;
    margin:0 auto;
    position:relative;
    box-shadow:inset 0 -6px 14px rgba(0,0,0,.06);
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    align-items:center;
  }

  /* water fill uses CSS variable --fill (0..100) */
  .bottle .water{
    position:absolute;left:0;right:0;bottom:0;
    height:calc(var(--fill,20) * 1%); /* scaled by container */
    background:linear-gradient(180deg,#81d4fa,#0288d1);
    border-radius:inherit;
    transition:height:400ms ease;
    transition:height .45s cubic-bezier(.2,.8,.2,1);
    will-change:height;
  }

  .eyes{position:relative;z-index:2;margin-top:72px;display:flex;gap:20px}
  .eye{width:24px;height:28px;background:#2b2b2b;border-radius:50%}
  .mouth{width:64px;height:30px;border-bottom:8px solid #333;border-radius:50%;margin-top:8px}

  /* Charts */
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;align-items:start}
  canvas{width:100%!important;height:180px!important}

  /* Profile */
  .profile p{line-height:1.6;color:#223}

  /* Responsive */
  @media (max-width:920px){
    .content{flex-direction:column}
    .left{max-width:none}
    .charts{grid-template-columns:1fr}
    .bottle-container{display:none}
  }
</style>
</head>
<body>

<div class="app" role="application">
  <div class="card" aria-labelledby="appTitle">
    <header class="top-nav">
      <div id="appTitle" class="logo">SENIMSU</div>
      <nav class="nav" aria-label="Main navigation">
        <button type="button" data-target="analyze" aria-pressed="true">Analyze</button>
        <button type="button" data-target="profile" aria-pressed="false">Profile</button>
      </nav>
    </header>

    <main class="content">
      <section class="left">
        <div id="analyze" class="section" aria-hidden="false">
          <h2>AI Water Quality Analyzer</h2>

          <p class="sr-only" id="sourceDesc">Choose water source type</p>
          <div class="source-grid" role="radiogroup" aria-labelledby="sourceDesc">
            <button class="source-btn" type="button" data-source="clean_snow" aria-pressed="false">Clean Snow</button>
            <button class="source-btn" type="button" data-source="urban_snow" aria-pressed="false">Urban Snow</button>
            <button class="source-btn" type="button" data-source="ice" aria-pressed="false">Ice</button>
            <button class="source-btn" type="button" data-source="sleet" aria-pressed="false">Sleet</button>
          </div>

          <p>Selected: <strong id="selected">None</strong></p>

          <label for="before">Enter turbidity (NTU)</label>
          <input id="before" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 85.4" aria-describedby="beforeHelp">
          <div id="beforeHelp" style="display:none">Turbidity in Nephelometric Turbidity Units (NTU)</div>

          <button class="primary" id="analyzeBtn" type="button">Analyze</button>

          <aside id="output" class="output" role="status" aria-live="polite" aria-hidden="true"></aside>

          <div id="advice" class="advice" aria-hidden="true"></div>

          <div class="status" aria-hidden="false">
            <div id="liveDepth" class="chip">Depth: --%</div>
            <div id="liveClean" class="chip">Cleanliness: --%</div>
          </div>

        </div>

        <div id="profile" class="section" aria-hidden="true">
          <h2>About Project</h2>
          <div class="profile">
            <p>
              SENIMSU Water AI simulates biochar filtration using a lightweight knowledge-based model.
              It estimates turbidity reduction, contamination risk, and purification confidence.
              This demo focuses on explainability and quick offline estimates and is not a substitute for laboratory testing.
            </p>
            <p><strong>How it works</strong>: Select source, enter turbidity, and the model returns estimated after-filtration turbidity, efficiency and likely contaminants.</p>
          </div>
        </div>
      </section>

      <aside class="right" aria-hidden="false">
        <div class="bottle-wrap" aria-hidden="true">
          <div class="bottle-container" id="bottleContainer" aria-hidden="true">
            <div class="bottle" role="img" aria-label="Water bottle visualization" style="--fill:20">
              <div class="water" id="bottleWater" aria-hidden="true"></div>
              <div class="eyes" aria-hidden="true"><span class="eye"></span><span class="eye"></span></div>
              <div class="mouth" aria-hidden="true"></div>
            </div>
          </div>
        </div>

        <div style="padding:12px;flex:1;display:flex;flex-direction:column;">
          <div class="charts" aria-hidden="false">
            <canvas id="depthChart" aria-label="Depth over time"></canvas>
            <canvas id="cleanChart" aria-label="Cleanliness over time"></canvas>
          </div>

          <div style="margin-top:auto;font-size:.9rem;color:#324;padding-top:12px">
            <p style="margin:0"><em>Tip:</em> If results indicate unsafe water, perform additional filtration and lab testing before drinking.</p>
          </div>
        </div>
      </aside>
    </main>
  </div>
</div>

<script>
/* ===================== Constants & Knowledge Base ===================== */
const AI_KNOWLEDGE = {
  clean_snow: { base: 0.97, risk: 0.02, cont: ["Dust","Organic particles"] },
  urban_snow: { base: 0.80, risk: 0.15, cont: ["Heavy metals","Oil","Salt"] },
  ice: { base: 0.92, risk: 0.05, cont: ["Minerals","Sediments"] },
  sleet: { base: 0.87, risk: 0.07, cont: ["Mixed solids","Microplastics"] }
};

const SAFE_TURBIDITY = 100;
const MAX_SERIES = 40;

/* Small utilities */
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const round = (v, dp = 0) => {
  const f = Math.pow(10, dp);
  return Math.round(v * f) / f;
};

/* ===================== Model (refactored & documented) ===================== */
/*
  aiPredict(beforeNTU, sourceKey)
  - beforeNTU: number (>=0)
  - sourceKey: one of keys in AI_KNOWLEDGE
  returns: { after, eff, conf, cont }
*/
function aiPredict(before, source) {
  if (!AI_KNOWLEDGE[source] || typeof before !== 'number' || before < 0) {
    throw new Error('Invalid prediction inputs');
  }

  const k = AI_KNOWLEDGE[source];

  // penalty increases with higher turbidity (heuristic)
  let penalty = 0;
  if (before > 300) penalty = 0.15;
  else if (before > 150) penalty = 0.10;
  else if (before > 50) penalty = 0.05;

  // effective efficiency after accounting for risk & penalty
  let efficiency = k.base - penalty - k.risk;

  // keep results in reasonable bounds
  efficiency = clamp(efficiency, 0.55, 0.99);

  const after = Math.max(0, Math.round(before * (1 - efficiency)));
  const effPct = Math.round(efficiency * 100);
  const confPct = Math.round(clamp((1 - penalty - k.risk) * 100, 10, 99));

  return { after, eff: effPct, conf: confPct, cont: k.cont.slice() };
}

/* ===================== UI & DOM helpers ===================== */

document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const sourceButtons = Array.from(document.querySelectorAll('.source-btn'));
  const selectedEl = document.getElementById('selected');
  const beforeInput = document.getElementById('before');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const output = document.getElementById('output');
  const advice = document.getElementById('advice');
  const liveDepth = document.getElementById('liveDepth');
  const liveClean = document.getElementById('liveClean');
  const bottle = document.getElementById('bottleContainer');
  const bottleWater = document.getElementById('bottleWater');

  let currentSource = null;

  /* Navigation (no inline onclicks) */
  Array.from(document.querySelectorAll('.nav button')).forEach(btn => {
    btn.addEventListener('click', () => {
      // toggle nav buttons
      document.querySelectorAll('.nav button').forEach(b => {
        const target = b.dataset.target;
        const pressed = (b === btn).toString();
        b.setAttribute('aria-pressed', pressed);
        const sec = document.getElementById(target);
        sec.setAttribute('aria-hidden', (b !== btn).toString());
      });
    });
  });

  /* Source selection behavior - acts like radio buttons */
  sourceButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      sourceButtons.forEach(b => b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
      currentSource = btn.dataset.source;
      selectedEl.textContent = btn.textContent;
    });
  });

  /* Analyze click */
  analyzeBtn.addEventListener('click', () => {
    performAnalysis();
  });

  /* Keyboard: allow Enter on input to analyze */
  beforeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      analyzeBtn.click();
    }
  });

  /* Create charts with better defaults and colors */
  const depthCtx = document.getElementById('depthChart').getContext('2d');
  const cleanCtx = document.getElementById('cleanChart').getContext('2d');

  const defaultOpts = {
    maintainAspectRatio: false,
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    plugins: { legend: { display: false } },
    scales: { x: { display: false }, y: { beginAtZero: true, max: 100 } }
  };

  const depthChart = new Chart(depthCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Depth %', data: [], fill: true, backgroundColor: 'rgba(2,136,209,0.15)', borderColor: 'rgba(2,136,209,0.95)', tension: 0.25 }]},
    options: defaultOpts
  });

  const cleanChart = new Chart(cleanCtx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Cleanliness %', data: [], fill: true, backgroundColor: 'rgba(129,212,250,0.16)', borderColor: 'rgba(3,169,244,0.9)', tension: 0.25 }]},
    options: defaultOpts
  });

  /* Live time series arrays */
  const labels = [];
  const depthSeries = [];
  const cleanSeries = [];

  const MAX_POINTS = MAX_SERIES;

  function pushSeries(timeLabel, depthVal, cleanVal) {
    if (labels.length >= MAX_POINTS) {
      labels.shift(); depthSeries.shift(); cleanSeries.shift();
    }
    labels.push(timeLabel);
    depthSeries.push(depthVal);
    cleanSeries.push(cleanVal);

    depthChart.data.labels = labels.slice();
    depthChart.data.datasets[0].data = depthSeries.slice();
    depthChart.update('none');

    cleanChart.data.labels = labels.slice();
    cleanChart.data.datasets[0].data = cleanSeries.slice();
    cleanChart.update('none');
  }

  function cleanlinessFromDepth(depth){
    // smoother mapping; depth in percent (0..100)
    return Math.round(100 * Math.exp(-depth/60));
  }

  /* Update the bottle and live labels */
  function updateLive(depthPercent) {
    const d = clamp(Math.round(depthPercent), 0, 100);
    const c = cleanlinessFromDepth(d);
    liveDepth.textContent = `Depth: ${d}%`;
    liveClean.textContent = `Cleanliness: ${c}%`;
    // set CSS variable for fill so layout is responsive
    const bottleEl = document.querySelector('.bottle');
    if (bottleEl) bottleEl.style.setProperty('--fill', String(clamp(d,0,100)));
    const t = new Date().toLocaleTimeString();
    pushSeries(t, d, c);
  }

  /* Safe DOM update helper to avoid innerHTML when possible */
  function renderOutput({before, after, eff, conf, cont, safe}) {
    // build content using elements for safety / readability
    output.innerHTML = ''; // small controlled clearing
    const wrap = document.createElement('div');

    const list = document.createElement('dl');
    list.style.margin = 0;

    const mk = (k, v) => {
      const dt = document.createElement('dt'); dt.style.fontWeight = '700'; dt.style.display='inline';
      dt.textContent = k + ' ';
      const dd = document.createElement('dd'); dd.style.display='inline'; dd.style.margin = '0 0 8px 6px';
      dd.textContent = v;
      list.appendChild(dt);
      list.appendChild(dd);
    };

    mk('Initial:', `${before} NTU`);
    mk('After filtration:', `${after} NTU`);
    mk('Efficiency:', `${eff}%`);
    mk('AI confidence:', `${conf}%`);
    mk('Detected contaminants:', cont.join(', '));
    mk('Status:', safe ? 'Safe after boiling' : 'Needs re-filtration');

    wrap.appendChild(list);

    output.appendChild(wrap);
    output.setAttribute('aria-hidden','false');

    // Advice / re-filter note
    if (!safe || conf < 70) {
      advice.textContent = '⚠️ AI suggests additional filtration or lab testing';
      advice.style.borderLeft = `6px solid ${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#ff9800'}`;
      advice.setAttribute('aria-hidden','false');
    } else {
      advice.setAttribute('aria-hidden','true');
    }
  }

  /* Primary action */
  function performAnalysis(){
    if (!currentSource) {
      alert('Please select a water source first.');
      return;
    }

    const beforeVal = Number(beforeInput.value);
    if (!Number.isFinite(beforeVal) || beforeVal < 0) {
      alert('Please enter a valid non-negative turbidity value (NTU).');
      return;
    }

    try {
      const r = aiPredict(beforeVal, currentSource);
      const safe = r.after <= SAFE_TURBIDITY;
      renderOutput({ before: beforeVal, after: r.after, eff: r.eff, conf: r.conf, cont: r.cont, safe });

      // Update live visualization; map turbidity -> depth percent roughly
      // Use a gentle mapping so typical turbidity values don't overflow the visual
      const depthPercent = clamp((beforeVal / 5), 0, 100); // same heuristic as original but clamped
      updateLive(depthPercent);

    } catch (err) {
      console.error(err);
      alert('Unexpected error while analyzing. See console for details.');
    }
  }

  // Initialize small demo datapoints so charts aren't empty
  updateLive(12);
  updateLive(18);
  updateLive(22);
});
</script>
</body>
</html>
